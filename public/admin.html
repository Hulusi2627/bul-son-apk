<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pro-Bul Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#0a0908;--sidebar:#111009;--card:#1a1815;--card2:#231f1b;
      --orange:#FF5C1A;--yellow:#FFD234;--green:#2a9d5c;--red:#e05050;--blue:#4da6ff;
      --text:#F5F0E8;--muted:#9A9286;--border:rgba(255,255,255,0.07);
    }
    body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;}

    /* SIDEBAR */
    .sidebar{width:240px;min-height:100vh;background:var(--sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;z-index:100;}
    .sidebar-logo{padding:28px 24px 20px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);}
    .logo-icon{width:40px;height:40px;background:var(--orange);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 8px 24px rgba(255,92,26,0.35);flex-shrink:0;}
    .logo-text{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;}
    .logo-text span{color:var(--orange);}
    .logo-badge{font-size:10px;background:rgba(255,92,26,0.15);color:var(--orange);border:1px solid rgba(255,92,26,0.25);border-radius:6px;padding:2px 7px;font-weight:700;letter-spacing:0.5px;display:inline-block;margin-top:2px;}
    .nav{flex:1;padding:16px 12px;display:flex;flex-direction:column;gap:4px;}
    .nav-item{display:flex;align-items:center;gap:12px;padding:11px 14px;border-radius:12px;cursor:pointer;transition:background 0.2s,color 0.2s;font-size:14px;font-weight:500;color:var(--muted);border:none;background:transparent;width:100%;text-align:left;}
    .nav-item:hover{background:rgba(255,255,255,0.05);color:var(--text);}
    .nav-item.active{background:rgba(255,92,26,0.12);color:var(--orange);font-weight:600;}
    .nav-icon{width:20px;text-align:center;font-size:16px;flex-shrink:0;}
    .nav-badge{margin-left:auto;background:var(--orange);color:white;border-radius:8px;padding:1px 7px;font-size:11px;font-weight:700;}
    .sidebar-footer{padding:16px 12px;border-top:1px solid var(--border);}
    .admin-info{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--card2);border-radius:12px;margin-bottom:8px;}
    .admin-avatar{width:34px;height:34px;background:var(--orange);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
    .admin-name{font-size:13px;font-weight:600;}
    .admin-role{font-size:11px;color:var(--muted);}
    .btn-logout{width:100%;padding:9px;background:rgba(224,80,80,0.1);border:1px solid rgba(224,80,80,0.2);color:#e05050;border-radius:10px;cursor:pointer;font-size:13px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:6px;}
    .btn-logout:hover{background:rgba(224,80,80,0.2);}

    /* MAIN */
    .main{margin-left:240px;flex:1;min-height:100vh;}
    .topbar{padding:20px 32px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--sidebar);position:sticky;top:0;z-index:50;}
    .page-title{font-family:'Syne',sans-serif;font-size:20px;font-weight:700;}
    .page-sub{font-size:13px;color:var(--muted);margin-top:2px;}
    .topbar-right{display:flex;align-items:center;gap:12px;}
    .last-upd{font-size:12px;color:var(--muted);}
    .refresh-btn{padding:8px 16px;background:rgba(255,92,26,0.1);border:1px solid rgba(255,92,26,0.25);color:var(--orange);border-radius:10px;cursor:pointer;font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px;transition:background 0.2s;}
    .refresh-btn:hover{background:rgba(255,92,26,0.2);}
    .content{padding:28px 32px;}

    /* SECTIONS */
    .section{display:none;animation:fadeIn 0.2s ease;}
    .section.active{display:block;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    /* STATS GRID */
    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px;}
    .stat-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;position:relative;overflow:hidden;cursor:default;}
    .stat-glow{position:absolute;top:-20px;right:-20px;width:80px;height:80px;border-radius:50%;opacity:0.1;}
    .stat-glow.orange{background:var(--orange);}
    .stat-glow.green{background:var(--green);}
    .stat-glow.blue{background:var(--blue);}
    .stat-glow.red{background:var(--red);}
    .stat-icon{font-size:22px;margin-bottom:10px;}
    .stat-value{font-family:'Syne',sans-serif;font-size:34px;font-weight:800;line-height:1;}
    .stat-value.orange{color:var(--orange);}
    .stat-value.green{color:var(--green);}
    .stat-value.blue{color:var(--blue);}
    .stat-value.yellow{color:var(--yellow);}
    .stat-label{font-size:12px;color:var(--muted);margin-top:6px;}
    .stat-sub{font-size:11px;margin-top:8px;padding:3px 8px;border-radius:6px;display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,0.05);color:var(--muted);}
    .stat-sub.g{background:rgba(42,157,92,0.1);color:#4caf8e;}
    .stat-sub.b{background:rgba(77,166,255,0.1);color:var(--blue);}

    /* CARDS / TABLES */
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:20px;}
    .card-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;}
    .card-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;}
    .card-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .search-input{padding:8px 14px;background:var(--card2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:13px;outline:none;width:200px;}
    .search-input:focus{border-color:rgba(255,92,26,0.4);}
    .search-input::placeholder{color:var(--muted);}
    .filter-btns{display:flex;gap:5px;}
    .fbtn{padding:6px 13px;background:var(--card2);border:1px solid var(--border);border-radius:9px;color:var(--muted);font-size:12px;font-weight:600;cursor:pointer;transition:all 0.15s;}
    .fbtn:hover{border-color:rgba(255,92,26,0.3);color:var(--text);}
    .fbtn.active{background:rgba(255,92,26,0.12);border-color:rgba(255,92,26,0.3);color:var(--orange);}
    table{width:100%;border-collapse:collapse;}
    thead tr{background:rgba(255,255,255,0.02);}
    th{padding:11px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--muted);letter-spacing:0.5px;text-transform:uppercase;white-space:nowrap;}
    td{padding:12px 16px;font-size:13px;border-bottom:1px solid var(--border);vertical-align:middle;}
    tr:last-child td{border-bottom:none;}
    tbody tr:hover{background:rgba(255,255,255,0.02);}
    .badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:7px;font-size:11px;font-weight:700;white-space:nowrap;}
    .bg{background:rgba(42,157,92,0.12);color:#4caf8e;}
    .bo{background:rgba(255,92,26,0.12);color:var(--orange);}
    .br{background:rgba(224,80,80,0.12);color:#e05050;}
    .bb{background:rgba(77,166,255,0.12);color:var(--blue);}
    .bm{background:rgba(154,146,134,0.1);color:var(--muted);}
    .by{background:rgba(255,210,52,0.12);color:var(--yellow);}
    .dot-on{width:8px;height:8px;border-radius:50%;background:#2a9d5c;box-shadow:0 0 6px rgba(42,157,92,0.7);display:inline-block;flex-shrink:0;}
    .dot-off{width:8px;height:8px;border-radius:50%;background:var(--muted);display:inline-block;flex-shrink:0;}
    .abtn{padding:5px 10px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid transparent;transition:opacity 0.15s;white-space:nowrap;}
    .abtn:hover{opacity:0.75;}
    .abtn-v{background:rgba(77,166,255,0.1);color:var(--blue);border-color:rgba(77,166,255,0.2);}
    .abtn-d{background:rgba(224,80,80,0.1);color:#e05050;border-color:rgba(224,80,80,0.2);}
    .abtn-s{background:rgba(255,210,52,0.1);color:var(--yellow);border-color:rgba(255,210,52,0.2);}
    .abtn-m{background:rgba(42,157,92,0.1);color:#4caf8e;border-color:rgba(42,157,92,0.2);}
    .ucell{display:flex;align-items:center;gap:10px;}
    .uava{width:32px;height:32px;border-radius:10px;background:linear-gradient(135deg,var(--orange),#764ba2);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;overflow:hidden;}
    .uava img{width:100%;height:100%;object-fit:cover;}
    .empty{padding:44px 20px;text-align:center;color:var(--muted);}
    .empty-i{font-size:44px;opacity:0.25;margin-bottom:10px;}

    /* REALTIME LISTS */
    .rt-item{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--border);}
    .rt-item:last-child{border-bottom:none;}
    .rt-name{font-size:13px;font-weight:500;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .rt-time{font-size:11px;color:var(--muted);flex-shrink:0;}

    /* DUAL GRID */
    .dual{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;}

    /* MODAL */
    .modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:500;align-items:center;justify-content:center;}
    .modal-bg.open{display:flex;}
    .modal-box{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:28px;max-width:460px;width:92%;max-height:85vh;overflow-y:auto;}
    .modal-title{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;margin-bottom:20px;}
    .mf{margin-bottom:14px;}
    .ml{font-size:11px;color:var(--muted);font-weight:700;letter-spacing:0.4px;text-transform:uppercase;margin-bottom:5px;display:block;}
    .mi{width:100%;padding:10px 14px;background:var(--card2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;outline:none;font-family:inherit;}
    .mi:focus{border-color:rgba(255,92,26,0.4);}
    .mfoot{display:flex;gap:10px;margin-top:18px;}
    .mc{flex:1;padding:11px;background:var(--card2);border:1px solid var(--border);border-radius:11px;color:var(--muted);cursor:pointer;font-weight:600;font-size:14px;font-family:inherit;}
    .mo{flex:1;padding:11px;background:var(--orange);border:none;border-radius:11px;color:white;cursor:pointer;font-weight:700;font-family:'Syne',sans-serif;font-size:14px;}
    .mo.danger{background:var(--red);}

    /* TOAST */
    .adm-toast{position:fixed;top:20px;right:20px;background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:12px 18px;font-size:13px;display:flex;align-items:center;gap:10px;z-index:1000;box-shadow:0 8px 32px rgba(0,0,0,0.5);opacity:0;transform:translateY(-10px);transition:opacity 0.25s,transform 0.25s;pointer-events:none;}
    .adm-toast.show{opacity:1;transform:translateY(0);}
    .adm-toast.s{border-color:rgba(42,157,92,0.4);}
    .adm-toast.e{border-color:rgba(224,80,80,0.4);}

    /* PROGRESS BAR */
    .prog-wrap{flex:1;height:5px;background:var(--card2);border-radius:3px;overflow:hidden;}
    .prog{height:100%;border-radius:3px;transition:width 0.4s;}

    @media(max-width:900px){
      .sidebar{width:58px;}
      .sidebar-logo>div,.admin-name,.admin-role,.btn-logout span{display:none;}
      .nav-item>span:not(.nav-icon){display:none;}
      .nav-badge{display:none;}
      .main{margin-left:58px;}
      .stats-grid{grid-template-columns:1fr 1fr;}
      .dual{grid-template-columns:1fr;}
      .content{padding:16px;}
    }
  </style>
</head>
<body>

<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-icon">âš½</div>
    <div>
      <div class="logo-text">Pro-<span>Bul</span></div>
      <div class="logo-badge">ADMIN</div>
    </div>
  </div>
  <nav class="nav">
    <button class="nav-item active" data-section="dashboard" onclick="navTo('dashboard',this)">
      <span class="nav-icon">ğŸ“Š</span><span>Dashboard</span>
    </button>
    <button class="nav-item" data-section="users" onclick="navTo('users',this)">
      <span class="nav-icon">ğŸ‘¥</span><span>KullanÄ±cÄ±lar</span>
      <span class="nav-badge" id="nb-users"></span>
    </button>
    <button class="nav-item" data-section="listings" onclick="navTo('listings',this)">
      <span class="nav-icon">ğŸ“¢</span><span>Ä°lanlar</span>
    </button>
    <button class="nav-item" data-section="messages" onclick="navTo('messages',this)">
      <span class="nav-icon">ğŸ’¬</span><span>Mesajlar</span>
    </button>
    <button class="nav-item" data-section="logs" onclick="navTo('logs',this)">
      <span class="nav-icon">ğŸ“</span><span>Loglar</span>
    </button>
  </nav>
  <div class="sidebar-footer">
    <div class="admin-info">
      <div class="admin-avatar">ğŸ‘‘</div>
      <div>
        <div class="admin-name" id="sb-name">Admin</div>
        <div class="admin-role">SÃ¼per YÃ¶netici</div>
      </div>
    </div>
    <button class="btn-logout" onclick="doLogout()">ğŸšª <span>Ã‡Ä±kÄ±ÅŸ Yap</span></button>
  </div>
</aside>

<main class="main">
  <div class="topbar">
    <div>
      <div class="page-title" id="pg-title">Dashboard</div>
      <div class="page-sub" id="pg-sub">Platform genel bakÄ±ÅŸ</div>
    </div>
    <div class="topbar-right">
      <span class="last-upd" id="last-upd"></span>
      <button class="refresh-btn" onclick="refreshNow()">ğŸ”„ Yenile</button>
    </div>
  </div>

  <div class="content">

    <!-- DASHBOARD -->
    <div id="s-dashboard" class="section active">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-glow orange"></div>
          <div class="stat-icon">ğŸ‘¥</div><div class="stat-value orange" id="v-total">â€”</div>
          <div class="stat-label">Toplam KullanÄ±cÄ±</div><div class="stat-sub b" id="v-new">â³ HesaplanÄ±yor</div>
        </div>
        <div class="stat-card"><div class="stat-glow green"></div>
          <div class="stat-icon">ğŸŸ¢</div><div class="stat-value green" id="v-online">â€”</div>
          <div class="stat-label">Åu An Ã‡evrimiÃ§i</div><div class="stat-sub g">ğŸ“¡ GerÃ§ek zamanlÄ±</div>
        </div>
        <div class="stat-card"><div class="stat-glow blue"></div>
          <div class="stat-icon">ğŸ“¢</div><div class="stat-value blue" id="v-listings">â€”</div>
          <div class="stat-label">Aktif Ä°lan</div><div class="stat-sub b" id="v-listings-sub">â³ YÃ¼kleniyor</div>
        </div>
        <div class="stat-card"><div class="stat-glow red"></div>
          <div class="stat-icon">ğŸ’¬</div><div class="stat-value yellow" id="v-messages">â€”</div>
          <div class="stat-label">Toplam Mesaj</div><div class="stat-sub">ğŸ“© TÃ¼m zamanlar</div>
        </div>
      </div>

      <div class="dual">
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸŸ¢ Åu An Ã‡evrimiÃ§i</div>
            <span style="font-size:11px;color:var(--muted);" id="online-ts">â€”</span>
          </div>
          <div style="padding:10px 16px;" id="online-list">
            <div class="empty"><div class="empty-i">ğŸ”„</div>YÃ¼kleniyor...</div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ• Son Ãœyeler</div></div>
          <div style="padding:10px 16px;" id="recent-users-list">
            <div class="empty"><div class="empty-i">ğŸ”„</div>YÃ¼kleniyor...</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><div class="card-title">ğŸ“¢ Son Eklenen Ä°lanlar</div></div>
        <table>
          <thead><tr>
            <th>KullanÄ±cÄ±</th><th>Spor</th><th>Konum</th><th>Tarih & Saat</th><th>Durum</th><th>Doluluk</th>
          </tr></thead>
          <tbody id="db-listings"><tr><td colspan="6" class="empty">YÃ¼kleniyor...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- USERS -->
    <div id="s-users" class="section">
      <div class="card">
        <div class="card-header">
          <div class="card-title">ğŸ‘¥ KullanÄ±cÄ± YÃ¶netimi</div>
          <div class="card-actions">
            <input type="text" class="search-input" id="u-search" placeholder="ğŸ” Ä°sim, e-posta..." oninput="renderUsers()">
            <div class="filter-btns">
              <button class="fbtn active" onclick="setUFilter('all',this)">TÃ¼mÃ¼</button>
              <button class="fbtn" onclick="setUFilter('online',this)">ğŸŸ¢ Online</button>
              <button class="fbtn" onclick="setUFilter('admin',this)">ğŸ‘‘ Admin</button>
            </div>
          </div>
        </div>
        <table>
          <thead><tr><th>KullanÄ±cÄ±</th><th>E-posta</th><th>Tel</th><th>Durum</th><th>Son GÃ¶rÃ¼lme</th><th>KayÄ±t</th><th>Ä°ÅŸlem</th></tr></thead>
          <tbody id="users-tbody"><tr><td colspan="7" class="empty">YÃ¼kleniyor...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- LISTINGS -->
    <div id="s-listings" class="section">
      <div class="card">
        <div class="card-header">
          <div class="card-title">ğŸ“¢ Ä°lan YÃ¶netimi</div>
          <div class="card-actions">
            <input type="text" class="search-input" id="l-search" placeholder="ğŸ” Spor, konum..." oninput="renderListings()">
            <div class="filter-btns">
              <button class="fbtn active" onclick="setLFilter('all',this)">TÃ¼mÃ¼</button>
              <button class="fbtn" onclick="setLFilter('active',this)">âœ… Aktif</button>
              <button class="fbtn" onclick="setLFilter('full',this)">ğŸ”´ Dolu</button>
              <button class="fbtn" onclick="setLFilter('cancelled',this)">âŒ Ä°ptal</button>
            </div>
          </div>
        </div>
        <table>
          <thead><tr><th>#</th><th>KullanÄ±cÄ±</th><th>Spor</th><th>Konum</th><th>Tarih</th><th>Doluluk</th><th>Durum</th><th>Ä°ÅŸlem</th></tr></thead>
          <tbody id="listings-tbody"><tr><td colspan="8" class="empty">YÃ¼kleniyor...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- MESSAGES -->
    <div id="s-messages" class="section">
      <div class="dual">
        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ“Š Mesaj Ä°statistikleri</div></div>
          <div style="padding:20px;" id="msg-stats-el">
            <div class="empty"><div class="empty-i">ğŸ”„</div>YÃ¼kleniyor...</div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ“¡ Platform Ã–zeti</div></div>
          <div style="padding:20px;" id="platform-summary">
            <div class="empty"><div class="empty-i">ğŸ”„</div>YÃ¼kleniyor...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- LOGS -->
    <div id="s-logs" class="section">
      <div class="card">
        <div class="card-header"><div class="card-title">ğŸ“ Admin Ä°ÅŸlem LoglarÄ±</div></div>
        <table>
          <thead><tr><th>Tarih & Saat</th><th>Admin</th><th>Ä°ÅŸlem</th><th>Hedef</th><th>Detay</th></tr></thead>
          <tbody id="logs-tbody"><tr><td colspan="5" class="empty">YÃ¼kleniyor...</td></tr></tbody>
        </table>
      </div>
    </div>

  </div>
</main>

<!-- MODAL: Mesaj -->
<div class="modal-bg" id="m-msg">
  <div class="modal-box">
    <div class="modal-title">âœ‰ï¸ KullanÄ±cÄ±ya Mesaj GÃ¶nder</div>
    <div class="mf"><label class="ml">AlÄ±cÄ±</label><input class="mi" id="mm-to" readonly></div>
    <div class="mf"><label class="ml">Mesaj</label><textarea class="mi" id="mm-text" rows="4" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..."></textarea></div>
    <div class="mfoot"><button class="mc" onclick="closeM('m-msg')">Ä°ptal</button><button class="mo" onclick="sendMsg()">ğŸ“¨ GÃ¶nder</button></div>
  </div>
</div>

<!-- MODAL: Durum -->
<div class="modal-bg" id="m-status">
  <div class="modal-box">
    <div class="modal-title">ğŸ”„ Ä°lan Durumunu DeÄŸiÅŸtir</div>
    <input type="hidden" id="sm-id">
    <div class="mf">
      <label class="ml">Yeni Durum</label>
      <select class="mi" id="sm-status">
        <option value="active">âœ… Aktif</option>
        <option value="full">ğŸ”´ Dolu</option>
        <option value="cancelled">âŒ Ä°ptal Edildi</option>
      </select>
    </div>
    <div class="mfoot"><button class="mc" onclick="closeM('m-status')">Ä°ptal</button><button class="mo" onclick="applyStatus()">GÃ¼ncelle</button></div>
  </div>
</div>

<!-- MODAL: Silme onayÄ± -->
<div class="modal-bg" id="m-del">
  <div class="modal-box">
    <div class="modal-title">âš ï¸ Silme OnayÄ±</div>
    <div style="color:var(--muted);font-size:14px;line-height:1.6;margin-bottom:4px;" id="del-text">Bu iÅŸlem geri alÄ±namaz!</div>
    <div class="mfoot"><button class="mc" onclick="closeM('m-del')">VazgeÃ§</button><button class="mo danger" id="del-ok-btn">Evet, Sil</button></div>
  </div>
</div>

<!-- TOAST -->
<div class="adm-toast" id="adm-toast"></div>

<script>
const API = window.location.origin;
let CU = null; // current admin user
let allUsers = [], allListings = [];
let uFilter = 'all', lFilter = 'all';
let curSection = 'dashboard';
const SPORT_ICONS = {futbol:'âš½',basketbol:'ğŸ€',basket:'ğŸ€',tenis:'ğŸ¾',voleybol:'ğŸ',okey:'ğŸ€„'};

// ====== INIT ======
window.addEventListener('DOMContentLoaded', async () => {
  const u = JSON.parse(localStorage.getItem('currentUser') || '{}');
  if (!u.id || !u.isAdmin) { alert('Admin yetkisi gerekli!'); window.location.href = '/'; return; }
  CU = u;
  document.getElementById('sb-name').textContent = u.name || 'Admin';
  await loadDashboard();
  setInterval(refreshOnline, 30000);
});

// ====== NAV ======
const PAGE_META = {
  dashboard: ['Dashboard', 'Platform genel bakÄ±ÅŸ'],
  users: ['KullanÄ±cÄ± YÃ¶netimi', 'TÃ¼m Ã¼yeleri yÃ¶net'],
  listings: ['Ä°lan YÃ¶netimi', 'Aktif ve pasif ilanlar'],
  messages: ['Mesaj & Ä°letiÅŸim', 'KullanÄ±cÄ± mesajlaÅŸma aktivitesi'],
  logs: ['Admin LoglarÄ±', 'GerÃ§ekleÅŸtirilen admin iÅŸlemleri']
};

async function navTo(sec, btn) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('s-' + sec).classList.add('active');
  if (btn) btn.classList.add('active');
  curSection = sec;
  document.getElementById('pg-title').textContent = PAGE_META[sec][0];
  document.getElementById('pg-sub').textContent = PAGE_META[sec][1];
  updTs('');
  if (sec === 'dashboard') await loadDashboard();
  else if (sec === 'users') await loadUsers();
  else if (sec === 'listings') await loadListings();
  else if (sec === 'messages') await loadMessages();
  else if (sec === 'logs') await loadLogs();
}

function refreshNow() { navTo(curSection, document.querySelector('.nav-item.active')); }
function updTs(msg) { document.getElementById('last-upd').textContent = msg || ('Son: ' + new Date().toLocaleTimeString('tr-TR')); }

// ====== DASHBOARD ======
async function loadDashboard() {
  try {
    const [statsR, usersR] = await Promise.all([
      fetch(`${API}/api/admin/stats?adminId=${CU.id}`),
      fetch(`${API}/api/admin/users?adminId=${CU.id}`)
    ]);
    const stats = await statsR.json();
    const usersD = await usersR.json();

    if (stats.success) {
      document.getElementById('v-total').textContent = stats.stats.total_users;
      document.getElementById('v-online').textContent = stats.stats.online_users;
      document.getElementById('v-listings').textContent = stats.stats.active_listings;
      document.getElementById('v-messages').textContent = stats.stats.total_messages;
      document.getElementById('v-listings-sub').textContent = 'ğŸ“¢ Toplam: ' + stats.stats.total_listings;

      const sportIcons = SPORT_ICONS;
      document.getElementById('db-listings').innerHTML = (stats.recentListings || []).map(l => `
        <tr>
          <td><div class="ucell"><div class="uava">ğŸ‘¤</div><strong>${h(l.user_name)}</strong></div></td>
          <td>${sportIcons[l.sport]||'ğŸ…'} ${h(l.sport)}</td>
          <td style="color:var(--muted);font-size:12px;">ğŸ“ ${h(l.location)}</td>
          <td style="font-size:12px;">${fd(l.date)} ${h(l.time||'')}</td>
          <td>${sbadge(l.status)}</td>
          <td>
            <div style="display:flex;align-items:center;gap:6px;">
              <div class="prog-wrap"><div class="prog" style="width:${Math.min(100,(l.current_players/l.player_count*100)).toFixed(0)}%;background:${l.current_players>=l.player_count?'var(--red)':'var(--orange)'};"></div></div>
              <span style="font-size:11px;color:var(--muted);">${l.current_players}/${l.player_count}</span>
            </div>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="6" class="empty">Ä°lan bulunamadÄ±</td></tr>';
    }

    if (usersD.success) {
      const today = new Date().toDateString();
      const newToday = usersD.users.filter(u => new Date(u.created_at).toDateString() === today).length;
      document.getElementById('v-new').textContent = 'ğŸ†• BugÃ¼n ' + newToday + ' yeni';
      allUsers = usersD.users;
      renderOnline(usersD.users);
      renderRecentUsers(usersD.users);
    }

    updTs();
  } catch(e) { toast('Dashboard yÃ¼klenemedi', 'e'); }
}

function renderOnline(users) {
  const online = users.filter(u => u.is_online && !u.is_admin);
  document.getElementById('v-online').textContent = online.length;
  document.getElementById('online-ts').textContent = new Date().toLocaleTimeString('tr-TR');
  const el = document.getElementById('online-list');
  if (!online.length) { el.innerHTML = '<div class="empty"><div class="empty-i">ğŸŒ™</div>Kimse Ã§evrimiÃ§i deÄŸil</div>'; return; }
  el.innerHTML = online.slice(0,10).map(u => `
    <div class="rt-item">
      <div class="uava" style="width:28px;height:28px;font-size:12px;">${u.profile_photo?`<img src="${h(u.profile_photo)}">`:'ğŸ‘¤'}</div>
      <div class="rt-name">${h(u.name)}</div>
      <span class="dot-on"></span>
    </div>
  `).join('');
}

function renderRecentUsers(users) {
  const el = document.getElementById('recent-users-list');
  const sorted = [...users].filter(u=>!u.is_admin).sort((a,b)=>new Date(b.created_at)-new Date(a.created_at)).slice(0,8);
  if (!sorted.length) { el.innerHTML = '<div class="empty"><div class="empty-i">ğŸ‘¥</div>Ãœye yok</div>'; return; }
  el.innerHTML = sorted.map(u => `
    <div class="rt-item">
      <div class="uava" style="width:28px;height:28px;font-size:12px;">ğŸ‘¤</div>
      <div class="rt-name">${h(u.name)}</div>
      <div class="rt-time">${ago(u.created_at)}</div>
    </div>
  `).join('');
}

async function refreshOnline() {
  try {
    const r = await fetch(`${API}/api/admin/users?adminId=${CU.id}`);
    const d = await r.json();
    if (d.success) {
      renderOnline(d.users);
      const online = d.users.filter(u=>u.is_online&&!u.is_admin).length;
      document.getElementById('v-online').textContent = online;
    }
  } catch(e){}
}

// ====== USERS ======
async function loadUsers() {
  try {
    const r = await fetch(`${API}/api/admin/users?adminId=${CU.id}`);
    const d = await r.json();
    if (d.success) {
      allUsers = d.users;
      document.getElementById('nb-users').textContent = d.users.filter(u=>!u.is_admin).length;
      renderUsers();
      updTs();
    }
  } catch(e) { toast('YÃ¼klenemedi','e'); }
}

function setUFilter(f, btn) {
  uFilter = f;
  document.querySelectorAll('#s-users .fbtn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderUsers();
}

function renderUsers() {
  const q = (document.getElementById('u-search')?.value||'').toLowerCase();
  let users = [...allUsers];
  if (uFilter==='online') users = users.filter(u=>u.is_online);
  if (uFilter==='admin') users = users.filter(u=>u.is_admin);
  if (q) users = users.filter(u=>(u.name||'').toLowerCase().includes(q)||(u.email||'').toLowerCase().includes(q)||(u.phone||'').includes(q));
  const tbody = document.getElementById('users-tbody');
  if (!users.length) { tbody.innerHTML = '<tr><td colspan="7" class="empty"><div class="empty-i">ğŸ‘¥</div>KullanÄ±cÄ± bulunamadÄ±</td></tr>'; return; }
  tbody.innerHTML = users.map(u => `
    <tr>
      <td>
        <div class="ucell">
          <div class="uava">${u.profile_photo?`<img src="${h(u.profile_photo)}">`:'ğŸ‘¤'}</div>
          <div>
            <div style="font-weight:600;">${h(u.name)}${u.is_admin?'<span class="badge bo" style="margin-left:6px;font-size:10px;">ğŸ‘‘ Admin</span>':''}</div>
            <div style="font-size:11px;color:var(--muted);">ID #${u.id}</div>
          </div>
        </div>
      </td>
      <td style="color:var(--muted);font-size:12px;">${h(u.email)}</td>
      <td style="font-size:12px;">${u.phone||'<span style="color:var(--muted)">â€”</span>'}</td>
      <td>
        ${u.is_online
          ? '<span style="display:flex;align-items:center;gap:5px;"><span class="dot-on"></span><span style="color:#4caf8e;font-size:12px;">Ã‡evrimiÃ§i</span></span>'
          : '<span style="display:flex;align-items:center;gap:5px;"><span class="dot-off"></span><span style="color:var(--muted);font-size:12px;">Ã‡evrimdÄ±ÅŸÄ±</span></span>'}
      </td>
      <td style="color:var(--muted);font-size:12px;">${ago(u.last_seen)}</td>
      <td style="color:var(--muted);font-size:12px;">${fd2(u.created_at)}</td>
      <td>
        <div style="display:flex;gap:5px;flex-wrap:wrap;">
          <button class="abtn abtn-v" onclick="window.open('/profile.html?userId=${u.id}','_blank')">ğŸ‘ Profil</button>
          ${!u.is_admin ? `
            <button class="abtn abtn-m" onclick="openMsgM(${u.id},'${h(u.name)}')">âœ‰ï¸</button>
            <button class="abtn abtn-d" onclick="confirmDel('user',${u.id},'${h(u.name)}')">ğŸ—‘</button>
          ` : ''}
        </div>
      </td>
    </tr>
  `).join('');
}

// ====== LISTINGS ======
async function loadListings() {
  try {
    const r = await fetch(`${API}/api/admin/listings?adminId=${CU.id}`);
    const d = await r.json();
    if (d.success) { allListings = d.listings; renderListings(); updTs(); }
  } catch(e) { toast('YÃ¼klenemedi','e'); }
}

function setLFilter(f, btn) {
  lFilter = f;
  document.querySelectorAll('#s-listings .fbtn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderListings();
}

function renderListings() {
  const q = (document.getElementById('l-search')?.value||'').toLowerCase();
  let items = [...allListings];
  if (lFilter!=='all') items = items.filter(l=>l.status===lFilter);
  if (q) items = items.filter(l=>(l.sport||'').toLowerCase().includes(q)||(l.location||'').toLowerCase().includes(q)||(l.user_name||'').toLowerCase().includes(q));
  const tbody = document.getElementById('listings-tbody');
  if (!items.length) { tbody.innerHTML = '<tr><td colspan="8" class="empty"><div class="empty-i">ğŸ“¢</div>Ä°lan bulunamadÄ±</td></tr>'; return; }
  tbody.innerHTML = items.map(l => `
    <tr>
      <td style="color:var(--muted);font-size:11px;">#${l.id}</td>
      <td><div style="font-weight:500;">${h(l.user_name)}</div><div style="font-size:11px;color:var(--muted);">${h(l.user_email||'')}</div></td>
      <td>${SPORT_ICONS[l.sport]||'ğŸ…'} ${h(l.sport)}</td>
      <td style="font-size:12px;color:var(--muted);">ğŸ“ ${h(l.location)}</td>
      <td style="font-size:12px;">${fd(l.date)}<br><span style="color:var(--muted);">${h(l.time||'')}</span></td>
      <td>
        <div style="display:flex;align-items:center;gap:5px;">
          <div class="prog-wrap"><div class="prog" style="width:${Math.min(100,(l.current_players/l.player_count)*100).toFixed(0)}%;background:${l.current_players>=l.player_count?'var(--red)':'var(--green)'}"></div></div>
          <span style="font-size:11px;color:var(--muted);">${l.current_players}/${l.player_count}</span>
        </div>
      </td>
      <td>${sbadge(l.status)}</td>
      <td>
        <div style="display:flex;gap:5px;">
          <button class="abtn abtn-s" onclick="openStatusM(${l.id},'${l.status}')">ğŸ”„</button>
          <button class="abtn abtn-d" onclick="confirmDel('listing',${l.id},'Ä°lan #${l.id}')">ğŸ—‘</button>
        </div>
      </td>
    </tr>
  `).join('');
}

// ====== MESSAGES ======
async function loadMessages() {
  try {
    const r = await fetch(`${API}/api/admin/stats?adminId=${CU.id}`);
    const d = await r.json();
    if (d.success) {
      document.getElementById('msg-stats-el').innerHTML = `
        <div style="display:flex;flex-direction:column;gap:12px;">
          ${statItem('ğŸ’¬', 'Toplam Mesaj', d.stats.total_messages, 'orange')}
          ${statItem('ğŸ‘¥', 'Toplam KullanÄ±cÄ±', d.stats.total_users, 'blue')}
          ${statItem('ğŸŸ¢', 'Åu An Ã‡evrimiÃ§i', d.stats.online_users, 'green')}
          ${statItem('ğŸ“¢', 'Aktif Ä°lan', d.stats.active_listings, 'yellow')}
        </div>`;
      document.getElementById('platform-summary').innerHTML = `
        <div style="display:flex;flex-direction:column;gap:12px;">
          ${statItem('ğŸ“Š', 'Toplam Ä°lan', d.stats.total_listings, 'orange')}
          ${statItem('ğŸ””', 'Toplam Bildirim', d.stats.total_notifications, 'blue')}
          ${statItem('ğŸ’¬', 'Mesaj/KullanÄ±cÄ± Ort.', d.stats.total_users > 0 ? (d.stats.total_messages/d.stats.total_users).toFixed(1) : 0, 'green')}
        </div>`;
    }
    updTs();
  } catch(e){}
}

function statItem(icon, label, val, color) {
  const colors = {orange:'var(--orange)',blue:'var(--blue)',green:'#4caf8e',yellow:'var(--yellow)'};
  return `<div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--card2);border-radius:12px;">
    <div style="font-size:24px;">${icon}</div>
    <div style="flex:1;">
      <div style="font-size:11px;color:var(--muted);font-weight:600;">${label}</div>
      <div style="font-size:22px;font-weight:800;color:${colors[color]||'var(--text)'};">${val}</div>
    </div>
  </div>`;
}

// ====== LOGS ======
async function loadLogs() {
  try {
    const r = await fetch(`${API}/api/admin/logs?adminId=${CU.id}`);
    const d = await r.json();
    const tbody = document.getElementById('logs-tbody');
    const icons = {DELETE_USER:'ğŸ—‘ğŸ‘¤',DELETE_LISTING:'ğŸ—‘ğŸ“¢',UPDATE_LISTING:'âœï¸ğŸ“¢'};
    if (!d.success || !d.logs?.length) {
      tbody.innerHTML = '<tr><td colspan="5" class="empty"><div class="empty-i">ğŸ“</div>HenÃ¼z log kaydÄ± yok</td></tr>';
      return;
    }
    tbody.innerHTML = d.logs.map(l => `
      <tr>
        <td style="font-size:12px;color:var(--muted);white-space:nowrap;">${new Date(l.created_at).toLocaleString('tr-TR')}</td>
        <td><span class="badge bo">ğŸ‘‘ ${h(l.admin_name||'Admin')}</span></td>
        <td><span class="badge bb">${icons[l.action]||'âš™ï¸'} ${h(l.action)}</span></td>
        <td style="font-size:12px;">${h(l.target_type||'â€”')} <strong>#${l.target_id||'â€”'}</strong></td>
        <td style="font-size:12px;color:var(--muted);">${h(l.details||'â€”')}</td>
      </tr>
    `).join('');
    updTs();
  } catch(e){}
}

// ====== ACTIONS ======
let pendDel = null;
function confirmDel(type, id, name) {
  pendDel = {type, id};
  document.getElementById('del-text').textContent = `"${name}" kalÄ±cÄ± olarak silinecek. Bu iÅŸlem geri alÄ±namaz!`;
  document.getElementById('del-ok-btn').onclick = async () => {
    closeM('m-del');
    if (pendDel.type === 'user') await doDelUser(pendDel.id);
    else await doDelListing(pendDel.id);
  };
  openM('m-del');
}

async function doDelUser(id) {
  const r = await fetch(`${API}/api/admin/users/${id}`, {
    method:'DELETE', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({adminId: CU.id})
  });
  const d = await r.json();
  if (d.success) { toast('âœ… KullanÄ±cÄ± silindi','s'); loadUsers(); }
  else toast('âŒ '+d.error,'e');
}

async function doDelListing(id) {
  const r = await fetch(`${API}/api/admin/listings/${id}`, {
    method:'DELETE', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({adminId: CU.id})
  });
  const d = await r.json();
  if (d.success) { toast('âœ… Ä°lan silindi','s'); loadListings(); }
  else toast('âŒ '+d.error,'e');
}

function openStatusM(id, cur) {
  document.getElementById('sm-id').value = id;
  document.getElementById('sm-status').value = cur;
  openM('m-status');
}

async function applyStatus() {
  const id = document.getElementById('sm-id').value;
  const status = document.getElementById('sm-status').value;
  closeM('m-status');
  const r = await fetch(`${API}/api/admin/listings/${id}`, {
    method:'PUT', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({adminId: CU.id, status})
  });
  const d = await r.json();
  if (d.success) { toast('âœ… Ä°lan gÃ¼ncellendi','s'); loadListings(); }
  else toast('âŒ '+d.error,'e');
}

let msgTarget = null;
function openMsgM(uid, name) {
  msgTarget = uid;
  document.getElementById('mm-to').value = name;
  document.getElementById('mm-text').value = '';
  openM('m-msg');
}

async function sendMsg() {
  const msg = document.getElementById('mm-text').value.trim();
  if (!msg) { toast('Mesaj boÅŸ olamaz','e'); return; }
  closeM('m-msg');
  const r = await fetch(`${API}/api/messages`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({senderId: CU.id, receiverId: msgTarget, message: msg})
  });
  const d = await r.json();
  toast(d.success ? 'âœ… Mesaj gÃ¶nderildi' : 'âŒ GÃ¶nderilemedi', d.success ? 's' : 'e');
}

function doLogout() {
  if (!confirm('Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸine emin misin?')) return;
  localStorage.removeItem('currentUser');
  window.location.href = '/';
}

// ====== MODAL ======
function openM(id) { document.getElementById(id).classList.add('open'); }
function closeM(id) { document.getElementById(id).classList.remove('open'); }
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.modal-bg').forEach(m => {
    m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
  });
});

// ====== TOAST ======
function toast(msg, type='s') {
  const el = document.getElementById('adm-toast');
  el.textContent = msg;
  el.className = 'adm-toast show ' + type;
  clearTimeout(el._t);
  el._t = setTimeout(() => el.classList.remove('show'), 3000);
}

// ====== HELPERS ======
function h(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function sbadge(s) {
  const m = {active:['bg','âœ… Aktif'],full:['br','ğŸ”´ Dolu'],cancelled:['bm','âŒ Ä°ptal']};
  const p = m[s] || ['bm','â€”'];
  return `<span class="badge ${p[0]}">${p[1]}</span>`;
}
function fd(d) {
  if (!d) return 'â€”';
  return new Date(d).toLocaleDateString('tr-TR',{day:'numeric',month:'short',year:'2-digit'});
}
function fd2(d) {
  if (!d) return 'â€”';
  return new Date(d).toLocaleDateString('tr-TR',{day:'numeric',month:'short'});
}
function ago(d) {
  if (!d) return 'â€”';
  const s = Math.floor((Date.now()-new Date(d))/1000);
  if (s < 60) return 'Az Ã¶nce';
  const m = Math.floor(s/60); if (m < 60) return m+'dk Ã¶nce';
  const hr = Math.floor(m/60); if (hr < 24) return hr+'sa Ã¶nce';
  return Math.floor(hr/24)+'g Ã¶nce';
}
</script>
</body>
</html>
